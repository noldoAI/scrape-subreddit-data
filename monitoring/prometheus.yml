global:
  scrape_interval: 30s
  evaluation_interval: 30s
  external_labels:
    monitor: 'reddit-scraper-monitor'

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']

rule_files:
  - "alerts.yml"

scrape_configs:
  # API Server metrics
  - job_name: 'reddit-scraper-api'
    static_configs:
      - targets: ['reddit-scraper-api:8000']
    metrics_path: /metrics
    scrape_interval: 30s

  # Node metrics (host)
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']

  # Container metrics
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']

  # Dynamic discovery for scraper containers via Docker
  - job_name: 'reddit-scrapers'
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 30s
    relabel_configs:
      # Only keep reddit scraper containers
      - source_labels: [__meta_docker_container_name]
        regex: '/reddit-(posts|comments)-scraper-.*'
        action: keep
      # Extract subreddit from container name
      - source_labels: [__meta_docker_container_name]
        regex: '/reddit-(posts|comments)-scraper-(.*)'
        target_label: subreddit
        replacement: '${2}'
      # Extract scraper type from container name
      - source_labels: [__meta_docker_container_name]
        regex: '/reddit-(posts|comments)-scraper-.*'
        target_label: scraper_type
        replacement: '${1}'
      # Only scrape port 9100 (metrics port)
      - source_labels: [__meta_docker_port_private]
        regex: '9100'
        action: keep

  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
